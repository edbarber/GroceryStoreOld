@model IEnumerable<Grocery>
@{
    ViewData["Title"] = "Groceries";
}

<h2>Groceries</h2>
<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading details-control"><span class="details-control-collapsed"></span>Search</div>
            <div class="panel-body hidden">
                <div class="form-group col-md-3">
                    <label for="searchName">Search name</label>
                    <input class="form-control" id="searchName" />
                </div>
                <div class="form-group col-md-3">
                    <label for="searchPrice">Search price</label>
                    <input class="form-control" id="searchPrice" />
                </div>
                <div class="form-group col-md-3">
                    <label for="searchWeight">Search weight</label>
                    <input class="form-control" id="searchWeight" />
                </div>
                <div class="form-group col-md-3">
                    <label for="searchConversionCode">Search conversion code</label>
                    <input class="form-control" id="searchConversionCode" />
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row" id="groceries">
@if (Model.Count() > 0)
{
    foreach (var item in Model)
    {
        <div class="col-md-4">
            <div class="thumbnail">
                <a asp-action="Stock" asp-controller="Home" asp-route-id="@item.GroceryId">
                @if (string.IsNullOrWhiteSpace(item.ImageUrl))
                {
                    <img src="~/images/imagenotavailable1-39de324.png" alt="Missing image" class="thumbnail-size" />
                }
                else
                {
                    <img src="@item.ImageUrl" alt="@item.ImageAlt" class="thumbnail-size" />
                }
                </a>
                <div class="caption">
                    <h3 class="name">@item.Name</h3>
                    <a asp-action="Stock" asp-controller="Home" asp-route-id="@item.GroceryId" class="btn btn-primary" style="width:100px;">Stock</a>
                    @if (item.Conversion != null)
                    {
                        <p class="font-weight-bold"><span class="price">@item.Price.ToString("C2")</span> per <span class="weight">@string.Format("{0:G29}", item.Weight)</span><span class="conversionCode">@item.Conversion.Code</span></p>
                    }
                    else
                    {
                        <p class="font-weight-bold"><span class="price">@item.Price.ToString("C2")</span></p>
                    }

                    @if (string.IsNullOrWhiteSpace(item.Description))
                    {
                        <p>N/A</p>
                    }
                    else
                    {
                        <p>@item.Description</p>
                    }
                </div>
            </div>
        </div>
    }
    <div class="col-md-12 hidden" id="searchResults">
        <p>There are no results to show.</p>
    </div>
}
else
{
    <div class="col-md-12">
        <p>There are no items to show.</p>
    </div>
}
</div>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            $('#searchName').on('keyup', function () {
                search($(this).val(), $('#searchPrice').val(), $('#searchWeight').val(), $('#searchConversionCode').val());
            });

            $('#searchPrice').on('keyup', function () {
                search($('#searchName').val(), $(this).val(), $('#searchWeight').val(), $('#searchConversionCode').val());
            });

            $('#searchWeight').on('keyup', function () {
                search($('#searchName').val(), $('#searchPrice').val(), $(this).val(), $('#searchConversionCode').val());
            });

            $('#searchConversionCode').on('keyup', function () {
                search($('#searchName').val(), $('#searchPrice').val(), $('#searchWeight').val(), $(this).val());
            });

            $('.details-control').on('click', function () {
                var sibling = $(this).next();
                var child = $(this).children()[0];

                if (!sibling.hasClass('hidden')) {
                    $(child).removeClass('details-control-open');
                    $(child).addClass('details-control-collapsed');
                    sibling.addClass('hidden');
                }
                else {
                    $(child).removeClass('details-control-collapsed');
                    $(child).addClass('details-control-open');
                    sibling.removeClass('hidden');
                }
            });
        });

        function search(name, price, weight, conversionCode) {

            var elements = $('#groceries > .col-md-4');
            var hiddenCount = 0;

            elements.each(function (index, element) {
                var included = true;
                var captionElement = $(element).children('.thumbnail').children('.caption').first();
                var text = "";

                text = captionElement.children('.name').first().text();
                included = compareString(text, name);

                // don't bother comparing again if it's not included
                if (included) {
                    text = captionElement.children('p').first().children('.price').first().text();
                    included = compareString(text, price);
                }

                if (included) {
                    var weightSpan = captionElement.children('p').first().children('.weight');

                    // weight needs to exist as weight can possibly not exist
                    if (weightSpan.length > 0) {
                        text = weightSpan.first().text();
                        included = compareString(text, weight);
                    }
                }

                if (included) {
                    var conversionCodeSpan = captionElement.children('p').first().children('.conversionCode');

                    // conversion code needs to exist as conversion code can possibly not exist
                    if (conversionCodeSpan.length > 0) {
                        text = conversionCodeSpan.first().text();
                        included = compareString(text, conversionCode);
                    }
                }

                if (!included) {
                    if (!$(element).hasClass('hidden')) {
                        $(element).addClass('hidden');
                    }

                    hiddenCount++;
                }
                else {
                    $(element).removeClass('hidden');
                }
            });

            var element = $('#searchResults');

            if (elements.length == hiddenCount) {
                element.removeClass('hidden');
            }
            else {
                if (!element.hasClass('hidden')) {
                    element.addClass('hidden');
                }
            }
        }

        function compareString(value, compareTo) {
            if (value.toLowerCase().includes(compareTo)) {
                return true;
            }

            return false;
        }
    </script>
}